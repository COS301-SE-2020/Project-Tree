<!DOCTYPE html>
<html>
    <head>
        <style>
            #toolbar{
                display: none;
            }
            #paper{
                height: 100vh; 
                width: 100vw;
            }
        </style>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.css" />
        <meta name="viewport" content="height=device-height, width=device-width, user-scalable=no" />
    </head>
    <body>
        <!-- content -->
        <!-- <div id="myholder"></div> -->
        <p id="p1">0</p>
        <div id="toolbar">
            <textarea id="adjacency-list" width="200">
            {
                "nodes": [
                    {"name": "host_a", "id": 21},
                    {"name": "comp_with_long_name", "id": 1},
                    {"name": "comp_b", "id": 2},
                    {"name": "host_b", "id": 22},
                    {"name": "comp_c", "id": 3},
                    {"name": "comp_d", "id": 4}
                ],
                "links": [
                    {"source": 1, "target": 21},
                    {"source": 2, "target": 21},
                    {"source": 3, "target": 22},
                    {"source": 4, "target": 22},
                    {"source": 4, "target": 21}
                ]
            }
        </textarea>
            <br/>
            <button id="btn-layout">Layout</button>
        </div>
        <div id="paper"></div>
        <!-- <p ontouchstart="TouchStart()" ontouchmove="TouchMove()">Touch me!</p> 
        ontouchstart="TouchStart()" ontouchmove="TouchMove()" ontouchend="TouchEnd()"-->
        

        <!-- dependencies -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/graphlib/2.1.8/graphlib.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.4/dagre-d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.js"></script>
        <!-- code -->
        <script type="text/javascript">
            var dragStartPosition
            var nodeTouch = false;
            var count = 0;

            var graph = new joint.dia.Graph();
            var paper = new joint.dia.Paper({
                el: $('#paper'),
                // width:  $('#paper').width(),
                // height: $('#paper').height(),
                // width: 800,
                // height: 600,
                gridSize: 1,
                model: graph,
                linkPinning: false
            });

            paper.on('element:pointerdown', (event) => {handleNodeClick(event.model.id)});
            paper.on('link:pointerdown', (event)=> {handleNodeClick("link")});
               
            function handleNodeClick(input){
                count++;
                nodeTouch = true
                document.getElementById("p1").innerHTML = input; 
                window.ReactNativeWebView.postMessage(input);
            }

            // paper.scale(1, 1)
            paper.on('blank:pointerdown', (event, x, y) =>{
                dragStartPosition = { x: x, y: y};
            });

            paper.on('blank:pointerup', ()=>{
                dragStartPosition = null;
            });
            
            paper.on('blank:pointermove', (event, x, y)=>{
                if (dragStartPosition){
                    paper.translate(
                        event.clientX - dragStartPosition.x, 
                        event.clientY - dragStartPosition.y
                    );
                }
            });

            // $("#paper").mousemove(function(event){
            //         if (dragStartPosition){
            //             paper.translate(
            //                 event.offsetX - dragStartPosition.x, 
            //                 event.offsetY - dragStartPosition.y
            //             );
            //         }
            // 	});
        // Helpers.
        // --------
        
        function buildGraph(data) {
            var elements = [];
            var links = [];
            
            _.each(data.nodes, function(node) {
            elements.push(makeElement(node));
            })
            
            _.each(data.links, function(edge) {
            links.push(makeLink(edge)); 
            })
            return elements.concat(links);
        }
        
        function makeLink(edge) {
            return new joint.shapes.standard.Link({
                source: { id: edge.source.toString() },
                target: { id: edge.target.toString() },
                attrs: {
                    type:'link'
                }
            })
        }
        
        function makeElement(node) {
        
            var maxLineLength = _.max(node.name.split('\n'), function(l) { return l.length; }).length;
        
            // Compute width/height of the rectangle based on the number
            // of lines in the label and the letter size. 0.6 * letterSize is
            // an approximation of the monospace font letter width.
            var letterSize = 8;
            var width = 2 * (letterSize * (0.6 * maxLineLength + 1));
            var height = 2 * ((node.name.split('\n').length + 1) * letterSize);

            return new joint.shapes.standard.Rectangle({
                id: node.id.toString(),
                size: { width: 100, height: height },
                attrs: {
                    type:'node',
                    text: { 
                        text: node.name, 
                        'font-size': letterSize, 
                        'font-family': 'monospace',
                    },
                    rect: {
                        rx: 10, ry: 10,
                        stroke: '#000',
                        //magnet: true
                        transform: 'translate(1, 1)'
                    }
                }
            });
        }
        
        // Main.
        // -----
        var graphScale = 1
        
        // Just give the viewport a little padding.
        V(paper.viewport).translate(20, 20);
        
        $('#btn-layout').on('click', layout);
        
        function layout() {
            
            try {
                var dataList = eval('dataList = ' + $('#adjacency-list').val());
            } catch (e) { alert(e); }
            
            var cells = buildGraph(dataList);
            graph.resetCells(cells);
            joint.layout.DirectedGraph.layout(graph, {
                dagre: dagre,
                graphlib: graphlib,
                setLinkVertices: false,
                rankDir: "LR",
                nodeSep: 100,
                rankSep: 100
            });
        }
        layout();

        </script>
    </body>
</html>